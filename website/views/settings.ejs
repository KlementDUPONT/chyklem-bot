<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Panel - <%= guild.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --sidebar-w: 260px; --bg: #202225; --card: #2f3136; --accent: #5865F2; --text: #dcddde; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .wrapper { display: flex; height: 100%; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-w); background: #2f3136; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #202225; }
        .server-header { display: flex; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #40444b; }
        .server-icon { width: 48px; height: 48px; border-radius: 50%; margin-right: 15px; }
        .nav-btn { display: block; padding: 12px 15px; color: #96989d; text-decoration: none; border-radius: 5px; margin-bottom: 5px; transition: 0.2s; cursor: pointer; font-weight: 600; }
        .nav-btn:hover, .nav-btn.active { background: #40444b; color: white; }
        .nav-btn i { width: 25px; text-align: center; margin-right: 10px; }
        .nav-category { font-size: 0.75rem; text-transform: uppercase; color: #8e9297; margin: 20px 0 10px 10px; font-weight: bold; }

        /* Content */
        .content { flex: 1; padding: 40px; overflow-y: auto; position: relative; }
        
        /* Cards */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 8px; border-left: 5px solid var(--accent); }
        .stat-value { font-size: 2rem; font-weight: bold; color: white; }
        .stat-label { color: #8e9297; }

        .module-section { display: none; animation: fadeIn 0.3s; }
        .module-section.active { display: block; }
        .config-box { background: var(--card); padding: 25px; border-radius: 8px; margin-bottom: 20px; }
        
        /* Forms */
        .form-control, .form-select { background: #202225; border: 1px solid #202225; color: white; padding: 12px; }
        .form-control:focus, .form-select:focus { background: #202225; color: white; border-color: var(--accent); box-shadow: none; }
        .form-switch .form-check-input { height: 1.5em; width: 3em; }
        .form-switch .form-check-input:checked { background-color: #3ba55d; border-color: #3ba55d; }

        /* Floating Save */
        .save-bar { position: absolute; bottom: -100px; left: 50%; transform: translateX(-50%); background: #18191c; padding: 15px 30px; border-radius: 50px; display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); transition: 0.3s; z-index: 999; }
        .save-bar.show { bottom: 30px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Preview Box */
        .preview-welcome { height: 150px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: 2px solid #5865F2; }
        .preview-text { font-size: 24px; font-weight: bold; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }
    </style>
</head>
<body>

    <div class="wrapper">
        <div class="sidebar">
            <div class="server-header">
                <% if (guild.icon) { %>
                    <img class="server-icon" src="https://cdn.discordapp.com/icons/<%= guild.id %>/<%= guild.icon %>.png">
                <% } else { %>
                    <div class="server-icon bg-primary d-flex align-items-center justify-content-center text-white fw-bold"><%= guild.name.charAt(0) %></div>
                <% } %>
                <div class="fw-bold text-truncate"><%= guild.name %></div>
            </div>

            <div class="nav-category">G√©n√©ral</div>
            <div class="nav-btn active" onclick="showTab('overview', this)"><i class="fas fa-chart-pie"></i> Vue d'ensemble</div>
            
            <div class="nav-category">Modules</div>
            <div class="nav-btn" onclick="showTab('welcome', this)"><i class="fas fa-door-open"></i> Bienvenue</div>
            <div class="nav-btn" onclick="showTab('levels', this)"><i class="fas fa-trophy"></i> Niveaux (XP)</div>
            <div class="nav-btn" onclick="showTab('moderation', this)"><i class="fas fa-gavel"></i> Mod√©ration</div>
            <div class="nav-btn" onclick="showTab('security', this)"><i class="fas fa-shield-alt"></i> S√©curit√©</div>

            <a href="/dashboard" class="nav-btn mt-auto text-danger"><i class="fas fa-sign-out-alt"></i> Quitter</a>
        </div>

        <div class="content">
            <form action="/settings/<%= guild.id %>" method="POST" id="settingsForm">

                <div id="overview" class="module-section active">
                    <h2 class="mb-4">Vue d'ensemble</h2>
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-value"><%= stats.memberCount %></div>
                            <div class="stat-label">Membres</div>
                        </div>
                        <div class="stat-card" style="border-color: #3ba55d;">
                            <div class="stat-value"><%= stats.botPing %>ms</div>
                            <div class="stat-label">Ping Bot</div>
                        </div>
                        <div class="stat-card" style="border-color: #faa61a;">
                            <div class="stat-value"><%= stats.channelCount %></div>
                            <div class="stat-label">Salons</div>
                        </div>
                        <div class="stat-card" style="border-color: #ed4245;">
                            <div class="stat-value"><%= stats.roleCount %></div>
                            <div class="stat-label">R√¥les</div>
                        </div>
                    </div>
                    <div class="config-box">
                        <h4>üëã Raccourci Rapide</h4>
                        <p class="text-muted">Configure ton message de bienvenue en un clic.</p>
                        <button type="button" class="btn btn-primary" onclick="showTab('welcome', document.querySelectorAll('.nav-btn')[2])">Aller √† Bienvenue</button>
                    </div>
                </div>

                <div id="welcome" class="module-section">
                    <h2 class="mb-4">Bienvenue & Design</h2>
                    
                    <div class="config-box">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Salon d'arriv√©e</label>
                                <select name="welcome_channel_id" class="form-select mb-3">
                                    <option value="">üö´ D√©sactiv√©</option>
                                    <% channels.forEach(c => { if(c.type===0){ %>
                                        <option value="<%= c.id %>" <%= settings.welcome_channel_id===c.id?'selected':'' %>>#<%= c.name %></option>
                                    <% }}) %>
                                </select>

                                <label class="form-label">R√¥le Automatique</label>
                                <select name="autorole_id" class="form-select mb-3">
                                    <option value="">üö´ Aucun</option>
                                    <% roles.forEach(r => { if(r.name!=='@everyone' && !r.managed){ %>
                                        <option value="<%= r.id %>" <%= settings.autorole_id===r.id?'selected':'' %>>@<%= r.name %></option>
                                    <% }}) %>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Aper√ßu Image</label>
                                <div class="preview-welcome mb-3" id="previewBox" style="background-image: url('<%= settings.welcome_bg %>');">
                                    <div class="preview-text" id="previewText" style="color: <%= settings.welcome_color %>;">BIENVENUE</div>
                                </div>
                                <div class="d-flex gap-2">
                                    <input type="text" name="welcome_bg" id="bgInput" class="form-control" placeholder="URL Image" value="<%= settings.welcome_bg %>">
                                    <input type="color" name="welcome_color" id="colorInput" class="form-control form-control-color" value="<%= settings.welcome_color %>">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="levels" class="module-section">
                    <h2 class="mb-4">Syst√®me de Niveaux</h2>
                    <div class="config-box d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Activer l'XP</h5>
                            <div class="text-muted">Les membres gagnent de l'XP en parlant.</div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="levels_enabled" <%= settings.levels_enabled ? 'checked' : '' %>>
                        </div>
                    </div>
                    <div class="config-box">
                        <label class="form-label">Message de mont√©e de niveau</label>
                        <input type="text" name="level_up_message" class="form-control" value="<%= settings.level_up_message %>">
                        <div class="form-text text-muted">Utilise <code>{user}</code> pour le membre et <code>{level}</code> pour le niveau.</div>
                    </div>
                </div>

                <div id="moderation" class="module-section">
                    <h2 class="mb-4">Mod√©ration</h2>
                    <div class="config-box">
                        <label class="form-label">Salon de Logs</label>
                        <select name="log_channel_id" class="form-select">
                            <option value="">üö´ D√©sactiv√©</option>
                            <% channels.forEach(c => { if(c.type===0){ %>
                                <option value="<%= c.id %>" <%= settings.log_channel_id===c.id?'selected':'' %>>#<%= c.name %></option>
                            <% }}) %>
                        </select>
                        <div class="form-text text-muted">Trace les messages supprim√©s, modifi√©s et les signalements.</div>
                    </div>
                </div>

                <div id="security" class="module-section">
                    <h2 class="mb-4">S√©curit√©</h2>
                    <div class="config-box d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-danger">Anti-Raid</h5>
                            <div class="text-muted">Kick automatique des comptes trop r√©cents.</div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="antiraid_enabled" <%= settings.antiraid_enabled ? 'checked' : '' %>>
                        </div>
                    </div>
                    <div class="config-box">
                        <label class="form-label">√Çge minimum (jours)</label>
                        <input type="number" name="antiraid_days" class="form-control" value="<%= settings.antiraid_account_age_days %>">
                    </div>
                </div>

                <div class="save-bar" id="saveBar">
                    <span class="text-white fw-bold">Modifications non enregistr√©es</span>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Annuler</button>
                    <button type="submit" class="btn btn-success">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Gestion des Onglets
        function showTab(tabId, btn) {
            document.querySelectorAll('.module-section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        // Preview Image
        const bgInput = document.getElementById('bgInput');
        const colorInput = document.getElementById('colorInput');
        const previewBox = document.getElementById('previewBox');
        const previewText = document.getElementById('previewText');

        function updatePreview() {
            previewBox.style.backgroundImage = `url('${bgInput.value}')`;
            previewText.style.color = colorInput.value;
        }
        bgInput.addEventListener('input', updatePreview);
        colorInput.addEventListener('input', updatePreview);

        // Barre de sauvegarde flottante
        const form = document.getElementById('settingsForm');
        const saveBar = document.getElementById('saveBar');
        
        form.addEventListener('change', () => {
            saveBar.classList.add('show');
        });
        
        function resetForm() {
            window.location.reload();
        }

        <% if (success) { %>
            // Petit toast de succ√®s (facultatif)
            alert('Sauvegard√© avec succ√®s !');
        <% } %>
    </script>
</body>
</html>