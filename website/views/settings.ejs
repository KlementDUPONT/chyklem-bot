<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Panel - <%= guild.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --sidebar-w: 260px; --bg: #202225; --card: #2f3136; --accent: #5865F2; --text: #dcddde; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        
        .wrapper { display: flex; height: 100%; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-w); background: #2f3136; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #202225; }
        .server-header { display: flex; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #40444b; }
        .server-icon { width: 48px; height: 48px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .nav-btn { display: block; padding: 12px 15px; color: #96989d; text-decoration: none; border-radius: 5px; margin-bottom: 5px; transition: 0.2s; cursor: pointer; font-weight: 600; }
        .nav-btn:hover, .nav-btn.active { background: #40444b; color: white; }
        .nav-btn i { width: 25px; text-align: center; margin-right: 10px; }
        .nav-category { font-size: 0.75rem; text-transform: uppercase; color: #8e9297; margin: 20px 0 10px 10px; font-weight: bold; }

        /* Content */
        .content { flex: 1; padding: 40px; overflow-y: auto; position: relative; }
        .module-section { display: none; animation: fadeIn 0.3s; }
        .module-section.active { display: block; }
        
        /* Elements */
        .config-box { background: var(--card); padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #202225; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 8px; border-left: 5px solid var(--accent); }
        .stat-value { font-size: 2rem; font-weight: bold; color: white; }
        .stat-label { color: #8e9297; }

        /* Formulaires & Tables */
        .form-control, .form-select { background: #202225; border: 1px solid #202225; color: white; padding: 12px; }
        .form-control:focus, .form-select:focus { background: #202225; color: white; border-color: var(--accent); box-shadow: none; }
        .form-label { font-weight: 600; color: #b9bbbe; margin-bottom: 8px; }
        .form-switch .form-check-input { height: 1.5em; width: 3em; cursor: pointer; }
        .form-switch .form-check-input:checked { background-color: #3ba55d; border-color: #3ba55d; }

        .cmd-table { width: 100%; border-collapse: collapse; }
        .cmd-table th { text-align: left; padding: 10px; color: #8e9297; border-bottom: 1px solid #40444b; }
        .cmd-table td { padding: 15px 10px; border-bottom: 1px solid #2f3136; }
        .cmd-trigger { background: #202225; padding: 5px 10px; border-radius: 4px; font-family: monospace; color: var(--accent); }

        /* Save Bar */
        .save-bar { position: absolute; bottom: -100px; left: 50%; transform: translateX(-50%); background: #18191c; padding: 15px 30px; border-radius: 50px; display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); transition: 0.3s; z-index: 999; border: 1px solid #444; }
        .save-bar.show { bottom: 30px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .preview-welcome { height: 180px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: 2px solid #5865F2; position: relative; overflow: hidden; }
        .preview-overlay { background: rgba(0,0,0,0.4); padding: 15px 30px; border-radius: 10px; text-align: center; }
        .preview-text { font-size: 24px; font-weight: bold; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }
    </style>
</head>
<body>

    <div class="wrapper">
        <div class="sidebar">
            <div class="server-header">
                <% if (guild.icon) { %>
                    <img class="server-icon" src="https://cdn.discordapp.com/icons/<%= guild.id %>/<%= guild.icon %>.png">
                <% } else { %>
                    <div class="server-icon bg-primary d-flex align-items-center justify-content-center text-white fw-bold"><%= guild.name.charAt(0) %></div>
                <% } %>
                <div class="fw-bold text-truncate"><%= guild.name %></div>
            </div>

            <div class="nav-category">G√©n√©ral</div>
            <div class="nav-btn active" onclick="showTab('overview', this)"><i class="fas fa-chart-pie"></i> Vue d'ensemble</div>
            <div class="nav-btn" onclick="showTab('customcmds', this)"><i class="fas fa-terminal"></i> Commandes Perso</div>
            <div class="nav-btn" onclick="showTab('economy', this)"><i class="fas fa-coins"></i> √âconomie</div>
            
            <div class="nav-category">Modules</div>
            <div class="nav-btn" onclick="showTab('welcome', this)"><i class="fas fa-door-open"></i> Bienvenue</div>
            <div class="nav-btn" onclick="showTab('social', this)"><i class="fas fa-gift"></i> Social & Anniv</div>
            <div class="nav-btn" onclick="showTab('levels', this)"><i class="fas fa-trophy"></i> Niveaux (XP)</div>
            <div class="nav-btn" onclick="showTab('moderation', this)"><i class="fas fa-gavel"></i> Mod√©ration</div>
            <div class="nav-btn" onclick="showTab('security', this)"><i class="fas fa-shield-alt"></i> S√©curit√©</div>

            <div class="nav-category">Logs</div>
            <div class="nav-btn" onclick="showTab('logs', this)"><i class="fas fa-list-alt"></i> Historique</div>

            <a href="/dashboard" class="nav-btn mt-auto text-danger"><i class="fas fa-sign-out-alt"></i> Quitter</a>
        </div>

        <div class="content">
            <% if (success) { %>
                <div class="alert alert-success position-fixed top-0 end-0 m-4" style="z-index: 1050; border-radius: 10px;" id="successAlert">
                    <i class="fas fa-check-circle me-2"></i> Sauvegard√© !
                </div>
                <script>setTimeout(() => document.getElementById('successAlert').style.display = 'none', 3000);</script>
            <% } %>

            <form action="/settings/<%= guild.id %>" method="POST" id="settingsForm">

                <div id="overview" class="module-section active">
                    <h2 class="mb-4">Vue d'ensemble</h2>
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-value"><%= stats.memberCount %></div>
                            <div class="stat-label">Membres</div>
                        </div>
                        <div class="stat-card" style="border-color: #3ba55d;">
                            <div class="stat-value"><%= stats.botPing %>ms</div>
                            <div class="stat-label">Ping Bot</div>
                        </div>
                        <div class="stat-card" style="border-color: #faa61a;">
                            <div class="stat-value"><%= stats.channelCount %></div>
                            <div class="stat-label">Salons</div>
                        </div>
                        <div class="stat-card" style="border-color: #ed4245;">
                            <div class="stat-value"><%= stats.roleCount %></div>
                            <div class="stat-label">R√¥les</div>
                        </div>
                    </div>
                </div>

                <div id="social" class="module-section">
                    <h2 class="mb-4">Social & Anniversaires</h2>
                    <div class="config-box">
                        <label class="form-label">Salon des Anniversaires</label>
                        <select name="birthday_channel_id" class="form-select">
                            <option value="">üö´ D√©sactiv√©</option>
                            <% channels.forEach(c => { if(c.type===0){ %>
                                <option value="<%= c.id %>" <%= settings.birthday_channel_id===c.id?'selected':'' %>>#<%= c.name %></option>
                            <% }}) %>
                        </select>
                        <div class="form-text text-muted">Le bot y souhaitera joyeux anniversaire le matin √† 08h00.</div>
                    </div>

                    <div class="config-box">
                        <h5>üèÜ Top Interactions (C√¢lins/Bisous)</h5>
                        <table class="cmd-table mt-3">
                            <thead><tr><th>De</th><th>Vers</th><th>Type</th><th>Total</th></tr></thead>
                            <tbody>
                                <% if (actionTop.length > 0) { %>
                                    <% actionTop.forEach(a => { %>
                                        <tr>
                                            <td><span class="cmd-trigger"><%= a.user_from %></span></td>
                                            <td><span class="cmd-trigger"><%= a.user_to %></span></td>
                                            <td><%= a.action_type %></td>
                                            <td class="fw-bold"><%= a.count %></td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr><td colspan="4" class="text-muted">Aucune interaction pour le moment.</td></tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="welcome" class="module-section">
                    <h2 class="mb-4">Bienvenue</h2>
                    <div class="config-box">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Salon d'arriv√©e</label>
                                <select name="welcome_channel_id" class="form-select mb-3">
                                    <option value="">üö´ D√©sactiv√©</option>
                                    <% channels.forEach(c => { if(c.type===0){ %>
                                        <option value="<%= c.id %>" <%= settings.welcome_channel_id===c.id?'selected':'' %>>#<%= c.name %></option>
                                    <% }}) %>
                                </select>
                                <label class="form-label">R√¥le Auto</label>
                                <select name="autorole_id" class="form-select mb-3">
                                    <option value="">üö´ Aucun</option>
                                    <% roles.forEach(r => { if(r.name!=='@everyone' && !r.managed){ %>
                                        <option value="<%= r.id %>" <%= settings.autorole_id===r.id?'selected':'' %>>@<%= r.name %></option>
                                    <% }}) %>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Aper√ßu</label>
                                <div class="preview-welcome mb-3" id="previewBox" style="background-image: url('<%= settings.welcome_bg || "https://i.imgur.com/vH1W4Qc.jpeg" %>');">
                                    <div class="preview-overlay">
                                        <div class="preview-text" id="previewText" style="color: <%= settings.welcome_color || "#ffffff" %>;">BIENVENUE</div>
                                    </div>
                                </div>
                                <input type="text" name="welcome_bg" id="bgInput" class="form-control mb-2" placeholder="URL Image" value="<%= settings.welcome_bg %>">
                                <input type="color" name="welcome_color" id="colorInput" class="form-control form-control-color w-100" value="<%= settings.welcome_color %>">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="levels" class="module-section">
                    <h2 class="mb-4">Niveaux</h2>
                    <div class="config-box d-flex justify-content-between align-items-center">
                        <div><h5>Activer l'XP</h5><div class="text-muted">Gain d'XP en discutant.</div></div>
                        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="levels_enabled" <%= settings.levels_enabled ? 'checked' : '' %>></div>
                    </div>
                    <div class="config-box">
                        <label class="form-label">Message Level Up</label>
                        <input type="text" name="level_up_message" class="form-control" value="<%= settings.level_up_message %>">
                    </div>
                </div>

                <div id="moderation" class="module-section">
                    <h2 class="mb-4">Mod√©ration</h2>
                    <div class="config-box">
                        <label class="form-label">Salon de Logs</label>
                        <select name="log_channel_id" class="form-select">
                            <option value="">üö´ D√©sactiv√©</option>
                            <% channels.forEach(c => { if(c.type===0){ %>
                                <option value="<%= c.id %>" <%= settings.log_channel_id===c.id?'selected':'' %>>#<%= c.name %></option>
                            <% }}) %>
                        </select>
                    </div>
                    <div class="config-box">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div><h5 class="text-warning">Auto-Mod</h5><div class="text-muted">Anti-insultes.</div></div>
                            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="automod_enabled" <%= settings.automod_enabled ? 'checked' : '' %>></div>
                        </div>
                        <label class="form-label">Mots interdits</label>
                        <textarea name="automod_words" class="form-control" rows="3"><%= settings.automod_words || '' %></textarea>
                    </div>
                </div>

                <div id="security" class="module-section">
                    <h2 class="mb-4">S√©curit√©</h2>
                    <div class="config-box d-flex justify-content-between align-items-center">
                        <div><h5 class="text-danger">Anti-Raid</h5><div class="text-muted">Kick comptes r√©cents.</div></div>
                        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="antiraid_enabled" <%= settings.antiraid_enabled ? 'checked' : '' %>></div>
                    </div>
                    <div class="config-box">
                        <label class="form-label">Jours minimum</label>
                        <input type="number" name="antiraid_days" class="form-control" value="<%= settings.antiraid_account_age_days %>">
                    </div>
                </div>

                <div class="save-bar" id="saveBar">
                    <span class="text-white fw-bold">Modifications non enregistr√©es</span>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="resetForm()">Annuler</button>
                    <button type="submit" class="btn btn-success btn-sm fw-bold px-4">Enregistrer</button>
                </div>

            </form>

            <div id="logs" class="module-section">
                <h2 class="mb-4">Historique & Sanctions</h2>
                <div class="config-box">
                    <h5>üìú Derni√®res Sanctions (Warns)</h5>
                    <table class="cmd-table mt-3">
                        <thead><tr><th>Date</th><th>Utilisateur</th><th>Mod√©rateur</th><th>Raison</th></tr></thead>
                        <tbody>
                            <% if (warnings.length > 0) { %>
                                <% warnings.forEach(w => { %>
                                    <tr>
                                        <td class="text-muted" style="font-size: 0.9em;"><%= new Date(w.date).toLocaleDateString() %></td>
                                        <td><span class="cmd-trigger"><%= w.user_id %></span></td>
                                        <td><span class="cmd-trigger"><%= w.moderator_id %></span></td>
                                        <td><%= w.reason %></td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr><td colspan="4" class="text-muted text-center py-4">Aucune sanction enregistr√©e.</td></tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="customcmds" class="module-section">
                <h2 class="mb-4">Commandes Perso</h2>
                <div class="config-box">
                    <form action="/settings/<%= guild.id %>/commands/add" method="POST" class="row g-3 align-items-end mt-2">
                        <div class="col-md-4"><label class="form-label">D√©clencheur</label><input type="text" name="trigger" class="form-control" placeholder="ex: !insta" required></div>
                        <div class="col-md-6"><label class="form-label">R√©ponse</label><input type="text" name="response" class="form-control" placeholder="..." required></div>
                        <div class="col-md-2"><button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus"></i></button></div>
                    </form>
                </div>
                <div class="config-box p-0 overflow-hidden">
                    <table class="cmd-table">
                        <% if (customCommands.length > 0) { %>
                            <% customCommands.forEach(cmd => { %>
                                <tr>
                                    <td><span class="cmd-trigger"><%= cmd.trigger_word %></span></td>
                                    <td class="text-muted"><%= cmd.response_text %></td>
                                    <td style="text-align: right;">
                                        <form action="/settings/<%= guild.id %>/commands/delete" method="POST" style="display:inline;">
                                            <input type="hidden" name="command_id" value="<%= cmd.id %>">
                                            <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                                        </form>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr><td colspan="3" class="text-center py-3 text-muted">Aucune commande.</td></tr>
                        <% } %>
                    </table>
                </div>
            </div>

            <div id="economy" class="module-section">
                <h2 class="mb-4">√âconomie</h2>
                <div class="config-box">
                    <h5>üèÜ Top 5 Richesse</h5>
                    <table class="cmd-table">
                        <% if (economyTop.length > 0) { %>
                            <% economyTop.forEach(eco => { %>
                                <tr>
                                    <td><span class="cmd-trigger"><%= eco.user_id %></span></td>
                                    <td class="text-success fw-bold"><%= eco.money %> $</td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr><td colspan="2" class="text-muted text-center py-3">Personne n'a d'argent...</td></tr>
                        <% } %>
                    </table>
                </div>
                <div class="config-box">
                    <h5>üëÆ Gestion Admin</h5>
                    <form action="/settings/<%= guild.id %>/economy/update" method="POST" class="row g-3 align-items-end mt-2">
                        <div class="col-md-4"><label class="form-label">ID User</label><input type="text" name="user_id" class="form-control" required></div>
                        <div class="col-md-3"><select name="action" class="form-select"><option value="add">Ajouter</option><option value="remove">Retirer</option><option value="set">D√©finir</option></select></div>
                        <div class="col-md-3"><input type="number" name="amount" class="form-control" required></div>
                        <div class="col-md-2"><button type="submit" class="btn btn-warning w-100"><i class="fas fa-check"></i></button></div>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <script>
        function showTab(tabId, btn) {
            document.querySelectorAll('.module-section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        const bgInput = document.getElementById('bgInput');
        const colorInput = document.getElementById('colorInput');
        const previewBox = document.getElementById('previewBox');
        const previewText = document.getElementById('previewText');
        function updatePreview() {
            if(bgInput.value) previewBox.style.backgroundImage = `url('${bgInput.value}')`;
            previewText.style.color = colorInput.value;
        }
        bgInput.addEventListener('input', updatePreview);
        colorInput.addEventListener('input', updatePreview);

        const settingsForm = document.getElementById('settingsForm');
        const saveBar = document.getElementById('saveBar');
        settingsForm.addEventListener('change', () => saveBar.classList.add('show'));
        function resetForm() { window.location.reload(); }
    </script>
</body>
</html>