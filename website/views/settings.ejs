<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Panel ‚ú® <%= guild.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #fdf2f8; --sidebar-bg: rgba(255, 255, 255, 0.6); --card-bg: rgba(255, 255, 255, 0.85); --text-main: #4a4a4a; --text-light: #7a7a7a; --primary: #ff9aa2; --radius: 25px; --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); }
        body { background: linear-gradient(135deg, #fff0f5 0%, #e6e6fa 100%); color: var(--text-main); font-family: 'Nunito', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        .wrapper { display: flex; height: 100%; }
        .sidebar { width: 280px; background: var(--sidebar-bg); backdrop-filter: blur(10px); padding: 30px 20px; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.5); }
        .server-header { text-align: center; margin-bottom: 30px; font-family: 'Fredoka', sans-serif; color: #5a5a5a; font-weight: bold; font-size: 1.2rem; }
        .nav-btn { padding: 12px 18px; color: var(--text-light); border-radius: 15px; margin-bottom: 8px; cursor: pointer; transition: 0.3s; font-weight: 700; display: flex; align-items: center; text-decoration: none; }
        .nav-btn:hover, .nav-btn.active { background: white; color: var(--primary); box-shadow: 0 5px 15px rgba(255, 154, 162, 0.2); }
        .nav-btn i { margin-right: 10px; width: 20px; text-align: center; }
        .content { flex: 1; padding: 40px 60px; overflow-y: auto; background-image: radial-gradient(#ff9aa2 1px, transparent 1px); background-size: 40px 40px; }
        .module-section { display: none; animation: slideUp 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .module-section.active { display: block; }
        .modules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; }
        .module-card { background: var(--card-bg); border-radius: 20px; padding: 25px; cursor: pointer; border: 2px solid white; position: relative; height: 180px; display: flex; flex-direction: column; justify-content: space-between; transition: 0.3s; box-shadow: var(--shadow); }
        .module-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .module-checkbox { position: absolute; top: 20px; right: 20px; width: 22px; height: 22px; accent-color: var(--primary); z-index: 10; cursor: pointer; }
        .icon-box { width: 55px; height: 55px; border-radius: 18px; display: flex; align-items: center; justify-content: center; color: white; font-size: 26px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .config-box { background: white; border-radius: 20px; padding: 30px; margin-bottom: 25px; box-shadow: var(--shadow); border: 2px solid rgba(255,255,255,0.8); }
        h2 { font-family: 'Fredoka', sans-serif; margin-bottom: 25px; color: #555; }
        h5 { font-family: 'Fredoka', sans-serif; margin-bottom: 15px; color: #777; }
        .table { --bs-table-bg: transparent; vertical-align: middle; }
        .save-bar { position: absolute; bottom: -100px; left: 50%; transform: translateX(-50%); background: white; padding: 15px 35px; border-radius: 50px; display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 40px rgba(255,154,162,0.4); transition: 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 999; border: 3px solid var(--primary); }
        .save-bar.show { bottom: 40px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="sidebar">
        <div class="server-header"><%= guild.name %></div>
        <hr style="border-color: rgba(0,0,0,0.1);">
        <div class="nav-btn" onclick="openTab('overview')"><i class="fas fa-th-large"></i> Accueil</div>
        <div class="nav-btn" onclick="openTab('presence')"><i class="fas fa-robot"></i> Pr√©sence Bot</div>
        <div class="nav-btn" onclick="openTab('reactionroles')"><i class="fas fa-magic"></i> R√©actions</div>
        <div class="nav-btn" onclick="openTab('welcome')"><i class="fas fa-door-open"></i> Bienvenue</div>
        <div class="nav-btn" onclick="openTab('timers')"><i class="fas fa-clock"></i> Timers</div>
        <div class="nav-btn" onclick="openTab('tempvoice')"><i class="fas fa-microphone"></i> Vocaux Temp</div>
        <div class="nav-btn" onclick="openTab('levels')"><i class="fas fa-trophy"></i> Niveaux</div>
        <div class="nav-btn" onclick="openTab('economy')"><i class="fas fa-coins"></i> √âconomie</div>
        <div class="nav-btn" onclick="openTab('moderation')"><i class="fas fa-shield-alt"></i> Mod√©ration</div>
        <div class="nav-btn" onclick="openTab('customcmds')"><i class="fas fa-terminal"></i> Commandes</div>
        <a href="/dashboard" class="nav-btn mt-auto text-danger"><i class="fas fa-arrow-left"></i> Retour</a>
    </div>

    <div class="content">
        <% if (success) { %>
            <div class="alert alert-success position-fixed top-0 end-0 m-4 shadow border-0" style="z-index: 1050; border-radius: 15px; background: #d4edda; color: #155724;">
                <i class="fas fa-check-circle me-2"></i> Sauvegard√© ! ‚ú®
            </div>
            <script>setTimeout(() => document.querySelector('.alert').remove(), 3500);</script>
        <% } %>

        <form action="/settings/<%= guild.id %>" method="POST" id="settingsForm" enctype="multipart/form-data">
            <input type="hidden" name="current_tab" id="currentTabInput" value="<%= activeTab %>">

            <div id="overview" class="module-section">
                <h2>Modules</h2>
                <div class="modules-grid">
                    <div class="module-card" onclick="openTab('presence')"><div class="icon-box" style="background:#ff9aa2"><i class="fas fa-robot"></i></div><h4>Pr√©sence Bot</h4></div>
                    <div class="module-card" onclick="openTab('reactionroles')"><input type="checkbox" name="module_reactionroles" class="module-checkbox" <%= settings.module_reactionroles ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#b5ead7"><i class="fas fa-magic"></i></div><h4>R√©actions</h4></div>
                    <div class="module-card" onclick="openTab('tempvoice')"><input type="checkbox" name="module_tempvoice" class="module-checkbox" <%= settings.module_tempvoice ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#c7ceea"><i class="fas fa-microphone"></i></div><h4>Vocaux Temp</h4></div>
                    <div class="module-card" onclick="openTab('timers')"><input type="checkbox" name="module_timers" class="module-checkbox" <%= settings.module_timers ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#e2f0cb"><i class="fas fa-clock"></i></div><h4>Timers</h4></div>
                    <div class="module-card" onclick="openTab('welcome')"><input type="checkbox" name="module_welcome" class="module-checkbox" <%= settings.module_welcome ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#ff9aa2"><i class="fas fa-door-open"></i></div><h4>Bienvenue</h4></div>
                    <div class="module-card" onclick="openTab('economy')"><input type="checkbox" name="module_economy" class="module-checkbox" <%= settings.module_economy ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#f6d365"><i class="fas fa-coins"></i></div><h4>√âconomie</h4></div>
                    <div class="module-card" onclick="openTab('moderation')"><input type="checkbox" name="module_moderation" class="module-checkbox" <%= settings.module_moderation ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#ff9a9e"><i class="fas fa-shield-alt"></i></div><h4>Mod√©ration</h4></div>
                </div>
            </div>

            <div id="welcome" class="module-section">
                <h2>Studio Bienvenue Pro üé®</h2>
                <div class="alert alert-info border-0 shadow-sm"><i class="fas fa-eye me-2"></i> L'aper√ßu ci-dessous se met √† jour en temps r√©el !</div>
                
                <div class="config-box text-center p-0 overflow-hidden bg-dark mb-4">
                    <canvas id="previewCanvas" width="700" height="250" style="max-width: 100%; height: auto; display: block; margin: 0 auto;"></canvas>
                </div>

                <div class="row">
                    <div class="col-lg-6">
                        <div class="config-box mb-3">
                            <h5>1. Fond & Image</h5>
                            <label class="form-label">Image de Fond</label>
                            <input type="file" name="welcome_bg_file" id="inp_file" class="form-control mb-2" accept="image/*">
                            <input type="text" name="welcome_bg" id="inp_url" class="form-control mb-2" value="<%= settings.welcome_bg %>" placeholder="Ou lien https://...">
                            <hr>
                            <label>Opacit√© du Voile (0 √† 1)</label>
                            <input type="number" name="welcome_opacity" id="inp_opacity" class="form-control live-inp" step="0.1" min="0" max="1" value="<%= settings.welcome_opacity %>">
                            <label class="mt-2">Alignement Texte</label>
                            <select name="welcome_align" id="inp_align" class="form-select live-inp">
                                <option value="left" <%= settings.welcome_align==='left'?'selected':'' %>>Gauche</option>
                                <option value="center" <%= settings.welcome_align==='center'?'selected':'' %>>Centr√©</option>
                                <option value="right" <%= settings.welcome_align==='right'?'selected':'' %>>Droite</option>
                            </select>
                        </div>
                        <div class="config-box">
                            <h5>2. Avatar</h5>
                            <div class="row g-2">
                                <div class="col-4"><label>X</label><input type="number" id="av_x" name="welcome_avatar_x" class="form-control live-inp" value="<%= settings.welcome_avatar_x %>"></div>
                                <div class="col-4"><label>Y</label><input type="number" id="av_y" name="welcome_avatar_y" class="form-control live-inp" value="<%= settings.welcome_avatar_y %>"></div>
                                <div class="col-4"><label>Taille</label><input type="number" id="av_s" name="welcome_avatar_size" class="form-control live-inp" value="<%= settings.welcome_avatar_size %>"></div>
                                <div class="col-6"><label>Forme</label><select id="av_shape" name="welcome_shape" class="form-select live-inp"><option value="circle" <%= settings.welcome_shape==='circle'?'selected':'' %>>Rond</option><option value="square" <%= settings.welcome_shape==='square'?'selected':'' %>>Carr√©</option></select></div>
                                <div class="col-6"><label>Bordure</label><input type="color" id="av_border" name="welcome_border_color" class="form-control w-100 live-inp" value="<%= settings.welcome_border_color %>"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="config-box mb-3">
                            <h5>3. Configuration Textes</h5>
                            <div class="card p-3 mb-3 border-0 bg-light">
                                <h6 class="fw-bold text-primary">Titre</h6>
                                <input type="text" id="t_txt" name="welcome_title" class="form-control mb-2 fw-bold live-inp" value="<%= settings.welcome_title %>">
                                <div class="row g-2">
                                    <div class="col-4"><label>X</label><input type="number" id="t_x" name="welcome_title_x" class="form-control live-inp" value="<%= settings.welcome_title_x %>"></div>
                                    <div class="col-4"><label>Y</label><input type="number" id="t_y" name="welcome_title_y" class="form-control live-inp" value="<%= settings.welcome_title_y %>"></div>
                                    <div class="col-4"><label>Taille</label><input type="number" id="t_s" name="welcome_title_size" class="form-control live-inp" value="<%= settings.welcome_title_size %>"></div>
                                    <div class="col-12"><label>Couleur</label><input type="color" id="t_col" name="welcome_title_color" class="form-control w-100 live-inp" value="<%= settings.welcome_title_color %>"></div>
                                </div>
                            </div>
                            <div class="card p-3 border-0 bg-light">
                                <h6 class="fw-bold text-success">Pseudo</h6>
                                <div class="row g-2">
                                    <div class="col-4"><label>X</label><input type="number" id="u_x" name="welcome_user_x" class="form-control live-inp" value="<%= settings.welcome_user_x %>"></div>
                                    <div class="col-4"><label>Y</label><input type="number" id="u_y" name="welcome_user_y" class="form-control live-inp" value="<%= settings.welcome_user_y %>"></div>
                                    <div class="col-4"><label>Taille</label><input type="number" id="u_s" name="welcome_user_size" class="form-control live-inp" value="<%= settings.welcome_user_size %>"></div>
                                    <div class="col-12"><label>Couleur</label><input type="color" id="u_col" name="welcome_user_color" class="form-control w-100 live-inp" value="<%= settings.welcome_user_color %>"></div>
                                </div>
                            </div>
                        </div>
                        <div class="config-box">
                            <label class="form-label">Salon d'envoi</label>
                            <select name="welcome_channel_id" class="form-select mb-2">
                                <option value="">D√©sactiv√©</option>
                                <% channels.forEach(c => { if(c.type===0){ %> <option value="<%= c.id %>" <%= settings.welcome_channel_id===c.id?'selected':'' %>>#<%= c.name %></option> <% }}) %>
                            </select>
                            <label class="form-label">Message texte</label>
                            <input type="text" name="welcome_message" class="form-control" value="<%= settings.welcome_message %>">
                        </div>
                    </div>
                </div>
            </div>

            <div class="save-bar" id="saveBar">
                <span class="fw-bold" style="color: #ff9aa2;"><i class="fas fa-pencil-alt me-2"></i> Modifications non enregistr√©es</span>
                <button type="button" class="btn btn-light text-muted btn-sm ms-3" onclick="window.location.reload()">Annuler</button>
                <button type="submit" class="btn btn-danger btn-sm px-4 ms-2" style="border-radius: 20px;">Enregistrer üíñ</button>
            </div>
        </form>

        <div id="presence" class="module-section"><h2>Pr√©sence</h2><div class="config-box"><p>Configurez la pr√©sence.</p></div></div>
        <div id="presence_actions" class="module-sub-section" style="display:none;"><div class="config-box mb-3"><form action="/settings/<%= guild.id %>/presence/config" method="POST"><div class="input-group"><span class="input-group-text">Intervalle</span><input type="number" name="interval" class="form-control" value="<%= locals.presenceInterval %>" min="5"><button class="btn btn-warning">OK</button></div></form></div><div class="config-box"><form action="/settings/<%= guild.id %>/presence/add" method="POST" class="row g-2"><div class="col-3"><select name="type" class="form-select"><option value="0">Joue</option><option value="2">√âcoute</option><option value="3">Regarde</option></select></div><div class="col-7"><input name="name" class="form-control" required></div><div class="col-2"><button class="btn btn-primary w-100">Add</button></div></form></div><div class="config-box mt-3"><table class="table"><% if(locals.botActivities) botActivities.forEach(a => { %><tr><td><%= a.name %></td><td class="text-end"><form action="/settings/<%= guild.id %>/presence/delete" method="POST"><input type="hidden" name="id" value="<%= a.id %>"><button class="btn btn-danger btn-sm">X</button></form></td></tr><% }) %></table></div></div>
        </div>
</div>

<script>
    const activeTabFromServer = "<%= activeTab %>";
    const userAvatarUrl = "<%= user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png' %>";
    
    // --- MOTEUR DE PREVIEW LIVE ---
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const inputs = document.querySelectorAll('.live-inp, #inp_file, #inp_url');
    let uploadedImage = null;

    // Charger l'image locale par d√©faut ou l'URL actuelle
    let currentBg = new Image();
    currentBg.src = "<%= settings.welcome_bg || '/assets/banner.png' %>"; // Fallback sur locale si vide
    currentBg.onload = renderPreview;
    
    // Gestion Upload Preview
    document.getElementById('inp_file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                uploadedImage = new Image();
                uploadedImage.onload = renderPreview;
                uploadedImage.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('inp_url').addEventListener('input', function(e) {
        if(e.target.value.startsWith('http')) {
            currentBg.src = e.target.value;
        }
    });

    function renderPreview() {
        // 1. Clear
        ctx.clearRect(0, 0, 700, 250);

        // 2. Fond
        const bgToDraw = uploadedImage || currentBg;
        try { ctx.drawImage(bgToDraw, 0, 0, 700, 250); } 
        catch(e) { ctx.fillStyle='#ff9aa2'; ctx.fillRect(0,0,700,250); }

        // 3. Overlay
        const opacity = parseFloat(document.getElementById('inp_opacity').value) || 0.5;
        ctx.fillStyle = `rgba(0,0,0,${opacity})`;
        ctx.fillRect(0,0,700,250);

        // 4. Avatar
        const ax = parseInt(document.getElementById('av_x').value) || 45;
        const ay = parseInt(document.getElementById('av_y').value) || 45;
        const as = parseInt(document.getElementById('av_s').value) || 160;
        const shape = document.getElementById('av_shape').value;
        const border = document.getElementById('av_border').value;

        ctx.save();
        ctx.beginPath();
        if(shape === 'circle') ctx.arc(ax + as/2, ay + as/2, as/2, 0, Math.PI * 2, true);
        else ctx.rect(ax, ay, as, as); // Pas de rounded rect simple en canvas old school, rect suffira pour preview
        ctx.closePath();
        ctx.lineWidth = 6;
        ctx.strokeStyle = border;
        ctx.stroke();
        ctx.clip();
        
        // Placeholder avatar pour preview
        const avatarImg = new Image();
        avatarImg.src = userAvatarUrl;
        // Astuce: On dessine l'avatar une fois charg√© (pour √©viter le clignotement, on le charge hors boucle mais ici c'est simple)
        if(avatarImg.complete) ctx.drawImage(avatarImg, ax, ay, as, as);
        else avatarImg.onload = () => ctx.drawImage(avatarImg, ax, ay, as, as);
        
        ctx.restore();

        // 5. Textes
        const align = document.getElementById('inp_align').value;
        ctx.textAlign = align;
        ctx.shadowColor="rgba(0,0,0,0.8)"; ctx.shadowBlur=4;

        // Titre
        const tx = parseInt(document.getElementById('t_x').value) || 230;
        const ty = parseInt(document.getElementById('t_y').value) || 110;
        const ts = parseInt(document.getElementById('t_s').value) || 50;
        ctx.fillStyle = document.getElementById('t_col').value;
        ctx.font = `bold ${ts}px sans-serif`; // Font standard pour preview
        ctx.fillText(document.getElementById('t_txt').value || 'BIENVENUE', tx, ty);

        // Pseudo
        const ux = parseInt(document.getElementById('u_x').value) || 230;
        const uy = parseInt(document.getElementById('u_y').value) || 175;
        const us = parseInt(document.getElementById('u_s').value) || 32;
        ctx.fillStyle = document.getElementById('u_col').value;
        ctx.font = `${us}px sans-serif`;
        ctx.fillText('USER_NAME', ux, uy);
    }

    // √âcouteurs d'√©v√©nements
    inputs.forEach(inp => {
        inp.addEventListener('input', renderPreview);
        inp.addEventListener('change', renderPreview);
    });

    // Init
    setTimeout(renderPreview, 500); // Petit d√©lai pour chargement image

    // --- ONGLETS ---
    function openTab(id) {
        document.querySelectorAll('.module-section').forEach(el => el.classList.remove('active'));
        const t = document.getElementById(id); if(t) t.classList.add('active');
        document.querySelectorAll('.module-sub-section').forEach(el => el.style.display = 'none');
        if(id==='presence') document.getElementById('presence_actions').style.display='block';
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        const btns = document.querySelectorAll('.nav-btn');
        btns.forEach(btn => { if(btn.innerHTML.includes(id) || (id==='overview'&&btn.innerHTML.includes('Accueil'))) btn.classList.add('active'); });
        document.getElementById('currentTabInput').value = id;
    }
    window.onload = () => { openTab(activeTabFromServer); renderPreview(); };
    document.getElementById('settingsForm').addEventListener('change', () => document.getElementById('saveBar').classList.add('show'));
</script>
</body>
</html>