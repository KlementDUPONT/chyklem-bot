<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Panel ‚ú® <%= guild.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #fdf2f8; --sidebar-bg: rgba(255, 255, 255, 0.6); --card-bg: rgba(255, 255, 255, 0.85); --text-main: #4a4a4a; --text-light: #7a7a7a; --primary: #ff9aa2; --radius: 25px; --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); }
        body { background: linear-gradient(135deg, #fff0f5 0%, #e6e6fa 100%); color: var(--text-main); font-family: 'Nunito', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        .wrapper { display: flex; height: 100%; }
        .sidebar { width: 280px; background: var(--sidebar-bg); backdrop-filter: blur(10px); padding: 30px 20px; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.5); }
        .server-header { text-align: center; margin-bottom: 30px; font-family: 'Fredoka', sans-serif; color: #5a5a5a; font-weight: bold; font-size: 1.2rem; }
        .nav-btn { padding: 12px 18px; color: var(--text-light); border-radius: 15px; margin-bottom: 8px; cursor: pointer; transition: 0.3s; font-weight: 700; display: flex; align-items: center; text-decoration: none; }
        .nav-btn:hover, .nav-btn.active { background: white; color: var(--primary); box-shadow: 0 5px 15px rgba(255, 154, 162, 0.2); }
        .nav-btn i { margin-right: 10px; width: 20px; text-align: center; }
        .content { flex: 1; padding: 40px 60px; overflow-y: auto; background-image: radial-gradient(#ff9aa2 1px, transparent 1px); background-size: 40px 40px; }
        .module-section { display: none; animation: slideUp 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .module-section.active { display: block; }
        .modules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; }
        .module-card { background: var(--card-bg); border-radius: 20px; padding: 25px; cursor: pointer; border: 2px solid white; position: relative; height: 180px; display: flex; flex-direction: column; justify-content: space-between; transition: 0.3s; box-shadow: var(--shadow); }
        .module-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .module-checkbox { position: absolute; top: 20px; right: 20px; width: 22px; height: 22px; accent-color: var(--primary); z-index: 10; cursor: pointer; }
        .icon-box { width: 55px; height: 55px; border-radius: 18px; display: flex; align-items: center; justify-content: center; color: white; font-size: 26px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .config-box { background: white; border-radius: 20px; padding: 30px; margin-bottom: 25px; box-shadow: var(--shadow); border: 2px solid rgba(255,255,255,0.8); }
        h2 { font-family: 'Fredoka', sans-serif; margin-bottom: 25px; color: #555; }
        h5 { font-family: 'Fredoka', sans-serif; margin-bottom: 15px; color: #777; }
        .table { --bs-table-bg: transparent; vertical-align: middle; }
        .user-cell { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; }
        .badge { padding: 8px 12px; border-radius: 10px; font-weight: 600; }
        .save-bar { position: absolute; bottom: -100px; left: 50%; transform: translateX(-50%); background: white; padding: 15px 35px; border-radius: 50px; display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 40px rgba(255,154,162,0.4); transition: 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 999; border: 3px solid var(--primary); }
        .save-bar.show { bottom: 40px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="sidebar">
        <div class="server-header"><%= guild.name %></div>
        <hr style="border-color: rgba(0,0,0,0.1);">
        <div class="nav-btn" onclick="openTab('overview')"><i class="fas fa-th-large"></i> Accueil</div>
        <div class="nav-btn" onclick="openTab('presence')"><i class="fas fa-robot"></i> Pr√©sence Bot</div>
        <div class="nav-btn" onclick="openTab('reactionroles')"><i class="fas fa-magic"></i> R√©actions</div>
        <div class="nav-btn" onclick="openTab('welcome')"><i class="fas fa-door-open"></i> Bienvenue</div>
        <div class="nav-btn" onclick="openTab('timers')"><i class="fas fa-clock"></i> Timers</div>
        <div class="nav-btn" onclick="openTab('tempvoice')"><i class="fas fa-microphone"></i> Vocaux Temp</div>
        <div class="nav-btn" onclick="openTab('levels')"><i class="fas fa-trophy"></i> Niveaux</div>
        <div class="nav-btn" onclick="openTab('economy')"><i class="fas fa-coins"></i> √âconomie</div>
        <div class="nav-btn" onclick="openTab('moderation')"><i class="fas fa-shield-alt"></i> Mod√©ration</div>
        <div class="nav-btn" onclick="openTab('customcmds')"><i class="fas fa-terminal"></i> Commandes</div>
        <a href="/dashboard" class="nav-btn mt-auto text-danger"><i class="fas fa-arrow-left"></i> Retour</a>
    </div>

    <div class="content">
        <% if (success) { %>
            <div class="alert alert-success position-fixed top-0 end-0 m-4 shadow border-0" style="z-index: 1050; border-radius: 15px; background: #d4edda; color: #155724;">
                <i class="fas fa-check-circle me-2"></i> Sauvegard√© ! ‚ú®
            </div>
            <script>setTimeout(() => document.querySelector('.alert').remove(), 3500);</script>
        <% } %>

        <form action="/settings/<%= guild.id %>" method="POST" id="settingsForm" enctype="multipart/form-data">
            <input type="hidden" name="current_tab" id="currentTabInput" value="<%= activeTab %>">

            <div id="overview" class="module-section">
                <h2>Modules</h2>
                <div class="modules-grid">
                    <div class="module-card" onclick="openTab('presence')"><div class="icon-box" style="background:#ff9aa2"><i class="fas fa-robot"></i></div><h4>Pr√©sence Bot</h4></div>
                    <div class="module-card" onclick="openTab('reactionroles')"><input type="checkbox" name="module_reactionroles" class="module-checkbox" <%= settings.module_reactionroles ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#b5ead7"><i class="fas fa-magic"></i></div><h4>R√©actions</h4></div>
                    <div class="module-card" onclick="openTab('tempvoice')"><input type="checkbox" name="module_tempvoice" class="module-checkbox" <%= settings.module_tempvoice ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#c7ceea"><i class="fas fa-microphone"></i></div><h4>Vocaux Temp</h4></div>
                    <div class="module-card" onclick="openTab('timers')"><input type="checkbox" name="module_timers" class="module-checkbox" <%= settings.module_timers ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#e2f0cb"><i class="fas fa-clock"></i></div><h4>Timers</h4></div>
                    <div class="module-card" onclick="openTab('welcome')"><input type="checkbox" name="module_welcome" class="module-checkbox" <%= settings.module_welcome ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#ff9aa2"><i class="fas fa-door-open"></i></div><h4>Bienvenue</h4></div>
                    <div class="module-card" onclick="openTab('economy')"><input type="checkbox" name="module_economy" class="module-checkbox" <%= settings.module_economy ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#f6d365"><i class="fas fa-coins"></i></div><h4>√âconomie</h4></div>
                    <div class="module-card" onclick="openTab('moderation')"><input type="checkbox" name="module_moderation" class="module-checkbox" <%= settings.module_moderation ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#ff9a9e"><i class="fas fa-shield-alt"></i></div><h4>Mod√©ration</h4></div>
                </div>
            </div>

            <div id="presence" class="module-section">
                <h2>Pr√©sence Bot ü§ñ</h2>
                <div class="config-box"><p class="text-muted">Ajoutez des statuts ci-dessous.</p></div>
            </div>

            <div id="welcome" class="module-section">
                <h2>Studio Bienvenue Pro üé®</h2>
                <div class="alert alert-info border-0 shadow-sm"><i class="fas fa-ruler-combined me-2"></i> L'image fait 700 pixels de large sur 250 pixels de haut. Utilisez ces valeurs pour placer vos √©l√©ments.</div>
                
                <div class="row">
                    <div class="col-lg-6">
                        <div class="config-box mb-3">
                            <h5>1. Fond & Image</h5>
                            <label class="form-label">Image de Fond</label>
                            <input type="file" name="welcome_bg_file" class="form-control mb-2" accept="image/*">
                            <input type="text" name="welcome_bg" class="form-control mb-2" value="<%= settings.welcome_bg %>" placeholder="Ou lien https://...">
                            <div class="form-text">Laisser vide pour utiliser 'banner.png' locale.</div>
                            <hr>
                            <label class="form-label">Opacit√© du Voile Noir (0 √† 1)</label>
                            <input type="number" name="welcome_opacity" class="form-control" step="0.1" min="0" max="1" value="<%= settings.welcome_opacity %>">
                            <label class="form-label mt-2">Alignement Texte</label>
                            <select name="welcome_align" class="form-select">
                                <option value="left" <%= settings.welcome_align==='left'?'selected':'' %>>Gauche</option>
                                <option value="center" <%= settings.welcome_align==='center'?'selected':'' %>>Centr√©</option>
                                <option value="right" <%= settings.welcome_align==='right'?'selected':'' %>>Droite</option>
                            </select>
                        </div>

                        <div class="config-box">
                            <h5>2. Avatar</h5>
                            <div class="row g-2">
                                <div class="col-6"><label>Pos X</label><input type="number" name="welcome_avatar_x" class="form-control" value="<%= settings.welcome_avatar_x %>"></div>
                                <div class="col-6"><label>Pos Y</label><input type="number" name="welcome_avatar_y" class="form-control" value="<%= settings.welcome_avatar_y %>"></div>
                                <div class="col-6"><label>Taille</label><input type="number" name="welcome_avatar_size" class="form-control" value="<%= settings.welcome_avatar_size %>"></div>
                                <div class="col-6"><label>Forme</label>
                                    <select name="welcome_shape" class="form-select">
                                        <option value="circle" <%= settings.welcome_shape==='circle'?'selected':'' %>>Rond</option>
                                        <option value="square" <%= settings.welcome_shape==='square'?'selected':'' %>>Carr√©</option>
                                    </select>
                                </div>
                                <div class="col-12"><label>Couleur Bordure</label><input type="color" name="welcome_border_color" class="form-control w-100" value="<%= settings.welcome_border_color %>"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="config-box mb-3">
                            <h5>3. Configuration Textes</h5>
                            <div class="card p-3 mb-3 border-0 bg-light">
                                <h6 class="fw-bold text-primary">Titre Principal</h6>
                                <input type="text" name="welcome_title" class="form-control mb-2 fw-bold" value="<%= settings.welcome_title %>">
                                <div class="row g-2">
                                    <div class="col-4"><label>Pos X</label><input type="number" name="welcome_title_x" class="form-control" value="<%= settings.welcome_title_x %>"></div>
                                    <div class="col-4"><label>Pos Y</label><input type="number" name="welcome_title_y" class="form-control" value="<%= settings.welcome_title_y %>"></div>
                                    <div class="col-4"><label>Taille</label><input type="number" name="welcome_title_size" class="form-control" value="<%= settings.welcome_title_size %>"></div>
                                    <div class="col-12"><label>Couleur</label><input type="color" name="welcome_title_color" class="form-control w-100" value="<%= settings.welcome_title_color %>"></div>
                                </div>
                            </div>

                            <div class="card p-3 border-0 bg-light">
                                <h6 class="fw-bold text-success">Pseudo Membre</h6>
                                <div class="row g-2">
                                    <div class="col-4"><label>Pos X</label><input type="number" name="welcome_user_x" class="form-control" value="<%= settings.welcome_user_x %>"></div>
                                    <div class="col-4"><label>Pos Y</label><input type="number" name="welcome_user_y" class="form-control" value="<%= settings.welcome_user_y %>"></div>
                                    <div class="col-4"><label>Taille Base</label><input type="number" name="welcome_user_size" class="form-control" value="<%= settings.welcome_user_size %>"></div>
                                    <div class="col-12"><label>Couleur</label><input type="color" name="welcome_user_color" class="form-control w-100" value="<%= settings.welcome_user_color %>"></div>
                                </div>
                            </div>
                        </div>

                        <div class="config-box">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Salon d'envoi</label>
                                    <select name="welcome_channel_id" class="form-select">
                                        <option value="">D√©sactiv√©</option>
                                        <% channels.forEach(c => { if(c.type===0){ %> <option value="<%= c.id %>" <%= settings.welcome_channel_id===c.id?'selected':'' %>>#<%= c.name %></option> <% }}) %>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Auto-R√¥le</label>
                                    <select name="autorole_id" class="form-select">
                                        <option value="">Aucun</option>
                                        <% roles.forEach(r => { if(r.name !== '@everyone' && !r.managed){ %> 
                                            <option value="<%= r.id %>" <%= settings.autorole_id===r.id?'selected':'' %>>@<%= r.name %></option> 
                                        <% }}) %>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Message texte (Discord)</label>
                                    <input type="text" name="welcome_message" class="form-control" value="<%= settings.welcome_message %>">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tempvoice" class="module-section">
                <h2>Vocaux Temporaires</h2>
                <div class="config-box">
                    <label class="form-label">Salon Cr√©ateur</label><select name="tempvoice_channel_id" class="form-select mb-3"><option value="">Non</option><% channels.forEach(c => { if(c.type===2){ %> <option value="<%= c.id %>" <%= settings.tempvoice_channel_id===c.id?'selected':'' %>>üîä <%= c.name %></option> <% }}) %></select>
                    <label class="form-label">Cat√©gorie</label><select name="tempvoice_category_id" class="form-select"><option value="">Non</option><% channels.forEach(c => { if(c.type===4){ %> <option value="<%= c.id %>" <%= settings.tempvoice_category_id===c.id?'selected':'' %>>üìÇ <%= c.name %></option> <% }}) %></select>
                </div>
            </div>
            <div id="levels" class="module-section"><h2>Niveaux</h2><div class="config-box"><label class="form-label">Message Level Up</label><input type="text" name="level_up_message" class="form-control" value="<%= settings.level_up_message %>"></div></div>
            <div id="moderation" class="module-section"><h2>Mod√©ration</h2><div class="config-box"><div class="row"><div class="col-md-6"><label class="form-label">Logs</label><select name="log_channel_id" class="form-select"><option value="">Non</option><% channels.forEach(c => { if(c.type===0){ %> <option value="<%= c.id %>" <%= settings.log_channel_id===c.id?'selected':'' %>>#<%= c.name %></option> <% }}) %></select></div><div class="col-md-6"><label class="form-label">Mots interdits</label><input type="text" name="automod_words" class="form-control" value="<%= settings.automod_words %>"></div></div></div><div class="config-box"><h5>Warns</h5><table class="table"><% warnings.forEach(w => { %><tr><td><%= new Date(w.date).toLocaleDateString() %></td><td><%= w.displayName %></td><td><%= w.reason %></td></tr><% }) %></table></div></div>

            <div class="save-bar" id="saveBar">
                <span class="fw-bold" style="color: #ff9aa2;"><i class="fas fa-pencil-alt me-2"></i> Modifications non enregistr√©es</span>
                <button type="button" class="btn btn-light text-muted btn-sm ms-3" onclick="window.location.reload()">Annuler</button>
                <button type="submit" class="btn btn-danger btn-sm px-4 ms-2" style="border-radius: 20px;">Enregistrer üíñ</button>
            </div>
        </form>

        <div id="presence_actions" class="module-sub-section" style="display:none;">
            <div class="config-box mb-3"><form action="/settings/<%= guild.id %>/presence/config" method="POST"><div class="input-group"><span class="input-group-text">Intervalle (s)</span><input type="number" name="interval" class="form-control" value="<%= locals.presenceInterval %>" min="5"><button class="btn btn-warning">OK</button></div></form></div>
            <div class="config-box"><form action="/settings/<%= guild.id %>/presence/add" method="POST" class="row g-2"><div class="col-3"><select name="type" class="form-select"><option value="0">Joue</option><option value="2">√âcoute</option><option value="3">Regarde</option></select></div><div class="col-7"><input name="name" class="form-control" required></div><div class="col-2"><button class="btn btn-primary w-100">Add</button></div></form></div>
            <div class="config-box mt-3"><table class="table"><% if(locals.botActivities) botActivities.forEach(a => { %><tr><td><%= a.name %></td><td class="text-end"><form action="/settings/<%= guild.id %>/presence/delete" method="POST"><input type="hidden" name="id" value="<%= a.id %>"><button class="btn btn-danger btn-sm">X</button></form></td></tr><% }) %></table></div>
        </div>
        <div id="timers_actions" class="module-sub-section" style="display:none;"><div class="config-box"><form action="/settings/<%= guild.id %>/timers/add" method="POST"><div class="row g-2"><div class="col-4"><select name="channel_id" class="form-select"><% channels.forEach(c => { if(c.type===0){ %><option value="<%= c.id %>">#<%= c.name %></option><% }}) %></select></div><div class="col-2"><input name="interval" type="number" class="form-control" placeholder="Min" required></div><div class="col-4"><input name="message" class="form-control" required></div><div class="col-2"><button class="btn btn-primary w-100">Add</button></div></div></form></div><div class="config-box mt-3"><table class="table"><% timers.forEach(t => { %><tr><td><%= t.message %> (<%= t.interval_minutes %>m)</td><td class="text-end"><form action="/settings/<%= guild.id %>/timers/delete" method="POST"><input type="hidden" name="id" value="<%= t.id %>"><button class="btn btn-danger btn-sm">X</button></form></td></tr><% }) %></table></div></div>
        <div id="economy_actions" class="module-sub-section" style="display:none;"><div class="config-box"><h5>Top 5</h5><table class="table"><% economyTop.forEach((e,i)=>{ %><tr><td>#<%= i+1 %></td><td><%= e.displayName %></td><td><%= e.money %> $</td></tr><% }) %></table></div></div>
    </div>
</div>
<script>
    const activeTabFromServer = "<%= activeTab %>";
    function openTab(id) {
        document.querySelectorAll('.module-section').forEach(el => el.classList.remove('active'));
        const t = document.getElementById(id); if(t) t.classList.add('active');
        document.querySelectorAll('.module-sub-section').forEach(el => el.style.display = 'none');
        if(id==='presence') document.getElementById('presence_actions').style.display='block';
        if(id==='timers') document.getElementById('timers_actions').style.display='block';
        if(id==='economy') document.getElementById('economy_actions').style.display='block';
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        const btns = document.querySelectorAll('.nav-btn');
        btns.forEach(btn => { if(btn.innerHTML.includes(id) || (id==='overview'&&btn.innerHTML.includes('Accueil'))) btn.classList.add('active'); });
        document.getElementById('currentTabInput').value = id;
    }
    window.onload = () => { openTab(activeTabFromServer); };
    document.getElementById('settingsForm').addEventListener('change', () => document.getElementById('saveBar').classList.add('show'));
</script>
</body>
</html>