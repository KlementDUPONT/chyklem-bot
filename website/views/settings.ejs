<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Panel âœ¨ <%= guild.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #fdf2f8; --sidebar-bg: rgba(255, 255, 255, 0.6); --primary: #ff9aa2; --radius: 25px; }
        body { background: linear-gradient(135deg, #fff0f5 0%, #e6e6fa 100%); font-family: 'Nunito', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        .wrapper { display: flex; height: 100%; }
        .sidebar { width: 280px; background: var(--sidebar-bg); backdrop-filter: blur(10px); padding: 30px 20px; display: flex; flex-direction: column; }
        .nav-btn { padding: 12px 18px; color: #7a7a7a; border-radius: 15px; margin-bottom: 8px; cursor: pointer; transition: 0.3s; font-weight: 700; display: flex; align-items: center; }
        .nav-btn:hover, .nav-btn.active { background: white; color: var(--primary); box-shadow: 0 5px 15px rgba(255, 154, 162, 0.2); }
        .content { flex: 1; padding: 40px 60px; overflow-y: auto; background-image: radial-gradient(#ff9aa2 1px, transparent 1px); background-size: 40px 40px; }
        .module-section { display: none; } .module-section.active { display: block; animation: slideUp 0.4s; }
        .modules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .module-card { background: rgba(255,255,255,0.8); border-radius: 20px; padding: 20px; cursor: pointer; border: 2px solid white; position: relative; height: 180px; display: flex; flex-direction: column; justify-content: space-between; }
        .module-checkbox { position: absolute; top: 15px; right: 15px; width: 20px; height: 20px; accent-color: var(--primary); z-index: 10; }
        .config-box { background: white; border-radius: 20px; padding: 30px; margin-bottom: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .save-bar { position: absolute; bottom: -100px; left: 50%; transform: translateX(-50%); background: white; padding: 15px 30px; border-radius: 50px; display: flex; gap: 20px; box-shadow: 0 10px 40px rgba(255,154,162,0.4); transition: 0.4s; z-index: 999; border: 3px solid var(--primary); }
        .save-bar.show { bottom: 40px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .icon-box { width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; margin-bottom: 10px; }
        .user-cell { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--primary); }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="sidebar">
        <h4 class="mb-4 text-center" style="color:#5a5a5a"><%= guild.name %></h4>
        <div class="nav-btn" onclick="openTab('overview')"><i class="fas fa-th-large me-2"></i> Accueil</div>
        <hr>
        <div class="nav-btn" onclick="openTab('reactionroles')"><i class="fas fa-magic me-2"></i> RÃ©actions</div>
        <div class="nav-btn" onclick="openTab('welcome')"><i class="fas fa-door-open me-2"></i> Bienvenue</div>
        <div class="nav-btn" onclick="openTab('timers')"><i class="fas fa-clock me-2"></i> Timers</div>
        <div class="nav-btn" onclick="openTab('tempvoice')"><i class="fas fa-microphone me-2"></i> Vocaux Temp</div>
        <div class="nav-btn" onclick="openTab('levels')"><i class="fas fa-trophy me-2"></i> Niveaux</div>
        <div class="nav-btn" onclick="openTab('customcmds')"><i class="fas fa-terminal me-2"></i> Commandes</div>
        <div class="nav-btn" onclick="openTab('moderation')"><i class="fas fa-shield-alt me-2"></i> ModÃ©ration</div>
        <div class="nav-btn" onclick="openTab('economy')"><i class="fas fa-coins me-2"></i> Ã‰conomie</div>
        <a href="/dashboard" class="nav-btn mt-auto text-danger"><i class="fas fa-arrow-left me-2"></i> Retour</a>
    </div>

    <div class="content">
        <% if (success) { %>
            <div class="alert alert-success position-fixed top-0 end-0 m-4 shadow" style="z-index: 1050; border-radius: 15px;">
                <i class="fas fa-check-circle me-2"></i> EnregistrÃ© !
            </div>
            <script>setTimeout(() => document.querySelector('.alert').remove(), 3000);</script>
        <% } %>

        <form action="/settings/<%= guild.id %>" method="POST" id="settingsForm">
            <input type="hidden" name="current_tab" id="currentTabInput" value="<%= activeTab %>">

            <div id="overview" class="module-section">
                <h2>Modules</h2>
                <div class="modules-grid">
                    <div class="module-card" onclick="openTab('reactionroles')"><input type="checkbox" name="module_reactionroles" class="module-checkbox" <%= settings.module_reactionroles ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#b5ead7"><i class="fas fa-magic"></i></div><h4>RÃ©actions</h4></div>
                    <div class="module-card" onclick="openTab('tempvoice')"><input type="checkbox" name="module_tempvoice" class="module-checkbox" <%= settings.module_tempvoice ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#c7ceea"><i class="fas fa-microphone"></i></div><h4>Vocaux Temp</h4></div>
                    <div class="module-card" onclick="openTab('timers')"><input type="checkbox" name="module_timers" class="module-checkbox" <%= settings.module_timers ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#e2f0cb"><i class="fas fa-clock"></i></div><h4>Timers</h4></div>
                    <div class="module-card" onclick="openTab('welcome')"><input type="checkbox" name="module_welcome" class="module-checkbox" <%= settings.module_welcome ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#ff9aa2"><i class="fas fa-door-open"></i></div><h4>Bienvenue</h4></div>
                    <div class="module-card" onclick="openTab('economy')"><input type="checkbox" name="module_economy" class="module-checkbox" <%= settings.module_economy ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#f6d365"><i class="fas fa-coins"></i></div><h4>Ã‰conomie</h4></div>
                    <div class="module-card" onclick="openTab('moderation')"><input type="checkbox" name="module_moderation" class="module-checkbox" <%= settings.module_moderation ? 'checked' : '' %> onclick="event.stopPropagation()"><div class="icon-box" style="background:#ff9a9e"><i class="fas fa-shield-alt"></i></div><h4>ModÃ©ration</h4></div>
                </div>
            </div>

            <div id="economy" class="module-section">
                <h2>Ã‰conomie</h2>
                <div class="config-box">
                    <h5>Top 5 Richesse</h5>
                    <table class="table">
                        <% economyTop.forEach((eco, index) => { %>
                            <tr>
                                <td width="50">#<%= index+1 %></td>
                                <td>
                                    <div class="user-cell">
                                        <img src="<%= eco.avatar %>" class="user-avatar">
                                        <strong><%= eco.displayName %></strong>
                                    </div>
                                </td>
                                <td class="text-end fw-bold text-success"><%= eco.money %> $</td>
                            </tr>
                        <% }) %>
                    </table>
                </div>
                <div class="config-box">
                    <h5>Gestion</h5>
                    <div class="row g-2">
                        <div class="col-md-4"><input type="text" name="user_id" class="form-control" placeholder="ID Utilisateur" required form="ecoForm"></div>
                        <div class="col-md-3"><select name="action" class="form-select" form="ecoForm"><option value="add">Ajouter (+)</option><option value="remove">Retirer (-)</option><option value="set">DÃ©finir (=)</option></select></div>
                        <div class="col-md-3"><input type="number" name="amount" class="form-control" placeholder="Montant" required form="ecoForm"></div>
                        <div class="col-md-2"><button type="submit" class="btn btn-warning w-100" form="ecoForm">Valider</button></div>
                    </div>
                </div>
            </div>

            <div id="moderation" class="module-section">
                <h2>ModÃ©ration</h2>
                <div class="config-box">
                    <div class="row">
                        <div class="col-md-6"><label>Logs</label><select name="log_channel_id" class="form-select"><option value="">Non</option><% channels.forEach(c => { if(c.type===0){ %><option value="<%= c.id %>" <%= settings.log_channel_id===c.id?'selected':'' %>>#<%= c.name %></option><% }}) %></select></div>
                        <div class="col-md-6"><label>Mots interdits</label><input type="text" name="automod_words" class="form-control" value="<%= settings.automod_words %>"></div>
                    </div>
                </div>
                <div class="config-box">
                    <h5>Derniers Warns</h5>
                    <table class="table">
                        <% warnings.forEach(w => { %>
                            <tr>
                                <td><small class="text-muted"><%= new Date(w.date).toLocaleDateString() %></small></td>
                                <td>
                                    <div class="user-cell">
                                        <img src="<%= w.avatar %>" class="user-avatar">
                                        <span><%= w.displayName %></span>
                                    </div>
                                </td>
                                <td><%= w.reason %></td>
                            </tr>
                        <% }) %>
                    </table>
                </div>
            </div>

            <div id="tempvoice" class="module-section"><h2>Vocaux Temp</h2><div class="config-box"><label>Salon CrÃ©ateur</label><select name="tempvoice_channel_id" class="form-select mb-3"><option value="">Non</option><% channels.forEach(c => { if(c.type===2){ %><option value="<%= c.id %>" <%= settings.tempvoice_channel_id===c.id?'selected':'' %>>ðŸ”Š <%= c.name %></option><% }}) %></select><label>CatÃ©gorie</label><select name="tempvoice_category_id" class="form-select"><option value="">Non</option><% channels.forEach(c => { if(c.type===4){ %><option value="<%= c.id %>" <%= settings.tempvoice_category_id===c.id?'selected':'' %>>ðŸ“‚ <%= c.name %></option><% }}) %></select></div></div>
            <div id="welcome" class="module-section"><h2>Bienvenue</h2><div class="config-box"><label>Salon</label><select name="welcome_channel_id" class="form-select mb-3"><option value="">Non</option><% channels.forEach(c => { if(c.type===0){ %><option value="<%= c.id %>" <%= settings.welcome_channel_id===c.id?'selected':'' %>>#<%= c.name %></option><% }}) %></select><label>URL Image</label><input name="welcome_bg" class="form-control" value="<%= settings.welcome_bg %>"></div></div>
            <div id="timers" class="module-section"><h2>Timers</h2><div class="config-box"><form action="/settings/<%= guild.id %>/timers/add" method="POST" class="row g-2 align-items-end"><div class="col-md-3"><label>Salon</label><select name="channel_id" class="form-select"><% channels.forEach(c => { if(c.type===0){ %><option value="<%= c.id %>">#<%= c.name %></option><% }}) %></select></div><div class="col-md-3"><label>RÃ´le</label><select name="role_id" class="form-select"><option value="">Non</option><% roles.forEach(r => { if(r.name!=='@everyone'){ %><option value="<%= r.id %>">@<%= r.name %></option><% }}) %></select></div><div class="col-md-2"><label>Min</label><input type="number" name="interval" class="form-control" required></div><div class="col-md-3"><label>Msg</label><input name="message" class="form-control" required></div><div class="col-md-1"><button class="btn btn-primary">+</button></div></form></div><div class="config-box"><table class="table"><% timers.forEach(t => { %><tr><td>#<%= (channels.get(t.channel_id)||{}).name %></td><td><% if(t.role_id){ %>@<%= (roles.get(t.role_id)||{}).name %><% } %></td><td><%= t.interval_minutes %>m</td><td><%= t.message %></td><td><form action="/settings/<%= guild.id %>/timers/delete" method="POST"><input type="hidden" name="id" value="<%= t.id %>"><button class="btn btn-danger btn-sm">X</button></form></td></tr><% }) %></table></div></div>
            <div id="reactionroles" class="module-section"><h2>RÃ©actions</h2><div class="config-box"><form action="/settings/<%= guild.id %>/rr/add" method="POST" class="row g-2"><div class="col-md-3"><label>Salon</label><select name="channel_id" class="form-select"><% channels.forEach(c => { if(c.type===0){ %><option value="<%= c.id %>">#<%= c.name %></option><% }}) %></select></div><div class="col-md-3"><label>Msg ID</label><input name="message_id" class="form-control"></div><div class="col-md-2"><label>Emoji</label><input name="emoji" class="form-control"></div><div class="col-md-2"><label>RÃ´le</label><select name="role_id" class="form-select"><% roles.forEach(r => { if(!r.managed){ %><option value="<%= r.id %>">@<%= r.name %></option><% }}) %></select></div><div class="col-md-2"><button class="btn btn-success w-100">Ajouter</button></div></form></div><div class="config-box"><table class="table"><% reactionRoles.forEach(rr => { %><tr><td>#<%= (channels.get(rr.channel_id)||{}).name %></td><td><%= rr.emoji %></td><td><%= (roles.get(rr.role_id)||{}).name %></td><td><form action="/settings/<%= guild.id %>/rr/delete" method="POST"><input type="hidden" name="id" value="<%= rr.id %>"><button class="btn btn-danger btn-sm">X</button></form></td></tr><% }) %></table></div></div>
            <div id="levels" class="module-section"><h2>Niveaux</h2><div class="config-box"><label>Message</label><input name="level_up_message" class="form-control" value="<%= settings.level_up_message %>"></div></div>
            <div id="customcmds" class="module-section"><h2>Commandes</h2><div class="config-box"><form action="/settings/<%= guild.id %>/commands/add" method="POST" class="row g-2"><div class="col-md-4"><input name="trigger" class="form-control" placeholder="!test"></div><div class="col-md-6"><input name="response" class="form-control" placeholder="RÃ©ponse..."></div><div class="col-md-2"><button class="btn btn-primary w-100">+</button></div></form></div><div class="config-box"><table class="table"><% customCommands.forEach(c => { %><tr><td><%= c.trigger_word %></td><td><%= c.response_text %></td><td><form action="/settings/<%= guild.id %>/commands/delete" method="POST"><input type="hidden" name="command_id" value="<%= c.id %>"><button class="btn btn-danger btn-sm">X</button></form></td></tr><% }) %></table></div></div>

            <div class="save-bar" id="saveBar">
                <span class="fw-bold" style="color: #ff9aa2;">Modifications en attente...</span>
                <button type="button" class="btn btn-light btn-sm ms-3" onclick="window.location.reload()">Annuler</button>
                <button type="submit" class="btn btn-danger btn-sm px-4 ms-2" style="border-radius: 20px;">Enregistrer</button>
            </div>
        </form>

        <form id="ecoForm" action="/settings/<%= guild.id %>/economy/update" method="POST"></form>
    </div>
</div>

<script>
    const activeTabFromServer = "<%= activeTab %>";
    function openTab(id) {
        document.querySelectorAll('.module-section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        const btns = document.querySelectorAll('.nav-btn');
        btns.forEach(btn => { if(btn.innerHTML.includes(id) || (id==='overview' && btn.innerHTML.includes('Accueil'))) btn.classList.add('active'); });
        document.getElementById('currentTabInput').value = id;
    }
    window.onload = () => { openTab(activeTabFromServer); };
    document.getElementById('settingsForm').addEventListener('change', () => document.getElementById('saveBar').classList.add('show'));
</script>
</body>
</html>